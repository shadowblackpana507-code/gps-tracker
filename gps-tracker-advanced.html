<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rastreador GPS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 400px; }
    #controls { padding: 10px; background: #f4f4f4; }
    input, button { margin: 5px; padding: 6px; }
    #list { max-height: 200px; overflow-y: auto; background: #fafafa; padding: 10px; }
    .item { margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 6px; }
    .small {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #0b76ef;
      background: #e0f2fe;
      color: #0b76ef;
      cursor: pointer;
      font-weight: 600;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h2 style="padding:10px;">Rastreador GPS</h2>
  <div id="map"></div>
  <div id="controls">
    <input type="text" id="label" placeholder="Etiqueta">
    <input type="number" id="lat" placeholder="Latitud" step="any">
    <input type="number" id="lon" placeholder="Longitud" step="any">
    <button id="btn-gps">Obtener ubicación (GPS)</button>
    <button id="btn-add">Registrar ubicación</button>
    <button id="btn-clear">Limpiar historial</button>
    <button id="btn-export">Exportar CSV</button>
    <input type="file" id="file-import" accept=".csv">
    <button id="btn-sample">Cargar muestras</button>
  </div>
  <div id="list"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Variables principales ---
    const map = L.map('map').setView([8.9833, -79.5167], 13); // Panamá por defecto
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let entries = JSON.parse(localStorage.getItem("gps_entries")||"[]");
    const markers = {};

    // --- Guardar y renderizar ---
    function save() {
      localStorage.setItem("gps_entries", JSON.stringify(entries));
    }

    function fitAllMarkers() {
      const group = L.featureGroup(Object.values(markers));
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function renderList() {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const rev = [...entries].sort((a,b)=> b.ts.localeCompare(a.ts));
      for (const e of rev) {
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML = `<b>${e.label||"(sin etiqueta)"}</b><br>
        ${e.lat.toFixed(5)}, ${e.lon.toFixed(5)}<br>
        ${e.ts}<br>
        <button class="small" onclick="centerOn('${e.id}')">Centrar</button>
        <button class="small" onclick="removeEntry('${e.id}')">Eliminar</button>`;
        list.appendChild(div);
      }
      refreshMarkers();
    }

    function refreshMarkers() {
      for (const id in markers) {
        map.removeLayer(markers[id]);
      }
      for (const e of entries) {
        const m = L.marker([e.lat,e.lon]).addTo(map).bindPopup(`${e.label}<br>${e.ts}`);
        markers[e.id]=m;
      }
      fitAllMarkers();
    }

    // --- Acciones ---
    function addEntry(label, lat, lon) {
      if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert("Coordenadas inválidas.");
        return;
      }
      const id = Date.now().toString();
      const ts = new Date().toLocaleString();
      entries.push({id,label,lat,lon,ts});
      save();
      renderList();
    }

    function centerOn(id) {
      const e = entries.find(x=>x.id===id);
      if (e) { map.setView([e.lat,e.lon], 15); }
    }

    function removeEntry(id) {
      entries = entries.filter(e=>e.id!==id);
      save();
      renderList();
    }

    // --- Exportar / Importar ---
    function exportCSV() {
      if (entries.length === 0) { 
        alert('No hay datos para exportar.'); 
        return; 
      }
      const rows = [['id','label','lat','lon','ts']];
      for (const e of entries) {
        rows.push([
          e.id, 
          `"${(e.label||'').replace(/"/g,'""')}"`, 
          e.lat, 
          e.lon, 
          e.ts
        ]);
      }
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gps_tracker_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("file-import").addEventListener("change", function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const lines = evt.target.result.split(/\r?\n/).slice(1);
        for (const line of lines) {
          if (!line.trim()) continue;
          const parts = line.split(",");
          if (parts.length>=5) {
            const [id,label,lat,lon,ts]=parts;
            entries.push({id,label:label.replace(/^"|"$/g,""),lat:parseFloat(lat),lon:parseFloat(lon),ts});
          }
        }
        save();
        renderList();
      }
      reader.readAsText(file);
    });

    // --- Botones ---
    document.getElementById("btn-add").onclick=()=>{
      const label=document.getElementById("label").value;
      const lat=parseFloat(document.getElementById("lat").value);
      const lon=parseFloat(document.getElementById("lon").value);
      if (isNaN(lat)||isNaN(lon)) { alert("Ingrese coordenadas válidas"); return; }
      addEntry(label,lat,lon);
    };

    document.getElementById("btn-clear").onclick=()=>{
      if (confirm("¿Seguro?")) {
        entries=[];
        save();
        renderList();
      }
    };

    document.getElementById("btn-export").onclick=exportCSV;

    document.getElementById("btn-gps").onclick=()=>{
      if (!navigator.geolocation) { alert("Geolocalización no soportada"); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude;
        const lon=pos.coords.longitude;
        document.getElementById("lat").value=lat;
        document.getElementById("lon").value=lon;
        addEntry("GPS",lat,lon);
      }, err=>{
        alert("Error obteniendo GPS: "+err.message);
      });
    };

    document.getElementById("btn-sample").onclick=()=>{
      addEntry("Casa",8.98,-79.52);
      addEntry("Trabajo",8.99,-79.55);
    };

    // --- Inicial ---
    renderList();
  </script>
</body>
</html>





