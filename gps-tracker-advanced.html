<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rastreador GPS - Funcional</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f8fafc; }
    .container {
      display:grid; grid-template-columns:400px 1fr; gap:16px;
      max-width:1100px; margin:auto; padding:16px;
    }
    #map { height: 600px; border-radius:8px; }
    .panel { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    label { font-size:13px; display:block; margin-top:6px; }
    input, select { width:100%; padding:6px; margin-top:4px; border:1px solid #ddd; border-radius:6px; }
    button { margin-top:8px; padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    button.primary { background:#0b76ef; color:#fff; }
    button.warn { background:#ef4444; color:#fff; }
    .item { border:1px solid #eee; padding:8px; margin-top:6px; border-radius:6px; background:#fafafa; }
    .coords { font-family:monospace; font-size:12px; }
    .actions button { font-size:11px; margin-left:4px; }
  </style>
</head>
<body>
  <div class="container">
    <div>
      <div class="panel">
        <h2>Registrar ubicación</h2>
        <label for="device">Número / ID del dispositivo:</label>
        <input id="device" type="text" placeholder="+50760000000 / Reloj Niño A">

        <label for="label">Etiqueta (opcional):</label>
        <input id="label" type="text" placeholder="Ej: Teléfono mamá">

        <label for="lat">Latitud:</label>
        <input id="lat" type="number" step="any">

        <label for="lon">Longitud:</label>
        <input id="lon" type="number" step="any">

        <button id="btn-get" class="primary">Obtener ubicación (GPS)</button>
        <button id="btn-add">Registrar ubicación</button>
        <button id="btn-clear" class="warn">Limpiar historial</button>

        <button id="btn-export">Exportar CSV</button>
        <label style="display:block;margin-top:6px;">
          <input type="file" id="file-import" accept=".csv" style="display:none;">
          <button id="btn-import">Importar CSV</button>
        </label>
        <button id="btn-sample">Cargar muestras</button>

        <h3>Filtrar por dispositivo</h3>
        <select id="filter">
          <option value="all">Todos</option>
        </select>
      </div>

      <div class="panel">
        <h3>Historial</h3>
        <div id="list"></div>
      </div>
    </div>
    <div>
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const STORAGE_KEY = "gps_multi_devices_final";
    let map, markers = {};
    let entries = [];

    const colors = ["red","blue","green","orange","purple","darkcyan","brown"];
    const deviceColors = {};
    function getColorForDevice(device) {
      if (!deviceColors[device]) {
        const used = Object.keys(deviceColors).length;
        deviceColors[device] = colors[used % colors.length];
      }
      return deviceColors[device];
    }
    function makeIcon(color) {
      return L.divIcon({
        className: "custom-icon",
        html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`,
        iconSize: [16,16], iconAnchor:[8,8]
      });
    }

    function initMap() {
      map = L.map("map").setView([9.0, -79.5], 8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
    function load(){ const raw=localStorage.getItem(STORAGE_KEY); if(raw) entries=JSON.parse(raw); }

    function render() {
      const list=document.getElementById("list"); list.innerHTML="";
      const filter=document.getElementById("filter").value;
      const filtered = filter==="all"?entries:entries.filter(e=>e.device===filter);
      if(filtered.length===0){ list.innerHTML="<p>No hay registros.</p>"; return; }
      filtered.sort((a,b)=>b.ts.localeCompare(a.ts));
      for(const e of filtered){
        const div=document.createElement("div"); div.className="item";
        div.innerHTML=`
          <b style="color:${getColorForDevice(e.device)}">${e.device}</b> - ${e.label||"Sin etiqueta"}<br>
          <span class="coords">${e.lat.toFixed(5)}, ${e.lon.toFixed(5)}</span><br>
          <small>${new Date(e.ts).toLocaleString()}</small>
          <div class="actions">
            <button data-act="center" data-id="${e.id}">Centrar</button>
            <button data-act="delete" data-id="${e.id}">Eliminar</button>
          </div>`;
        list.appendChild(div);
      }
      list.querySelectorAll("button[data-act='center']").forEach(btn=>{
        btn.onclick=()=>{ const e=entries.find(x=>x.id===btn.dataset.id);
          if(e&&markers[e.id]){ map.setView([e.lat,e.lon],16); markers[e.id].openPopup(); } };
      });
      list.querySelectorAll("button[data-act='delete']").forEach(btn=>{
        btn.onclick=()=>{ entries=entries.filter(x=>x.id!==btn.dataset.id); save(); refresh(); };
      });
    }

    function refresh(){
      Object.values(markers).forEach(m=>map.removeLayer(m)); markers={};
      for(const e of entries){
        const color=getColorForDevice(e.device);
        const m=L.marker([e.lat,e.lon],{icon:makeIcon(color)}).addTo(map)
          .bindPopup(`<b style="color:${color}">${e.device}</b><br>${e.label||"Sin etiqueta"}<br>${new Date(e.ts).toLocaleString()}`);
        markers[e.id]=m;
      }
      render(); updateFilterOptions();
    }
    function updateFilterOptions(){
      const sel=document.getElementById("filter");
      const devices=[...new Set(entries.map(e=>e.device))];
      sel.innerHTML="<option value='all'>Todos</option>";
      devices.forEach(d=>{ const opt=document.createElement("option"); opt.value=d; opt.textContent=d; sel.appendChild(opt); });
    }

    function addEntry(device,label,lat,lon){
      const id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
      entries.push({id,device,label,lat:parseFloat(lat),lon:parseFloat(lon),ts:new Date().toISOString()});
      save(); refresh();
    }

    // --- Botones y eventos ---
    document.getElementById("btn-add").onclick=()=>{
      const device=document.getElementById("device").value.trim();
      const label=document.getElementById("label").value.trim();
      const lat=parseFloat(document.getElementById("lat").value);
      const lon=parseFloat(document.getElementById("lon").value);
      if(!device){alert("Ingresa número o ID del dispositivo");return;}
      if(isNaN(lat)||isNaN(lon)){alert("Coordenadas inválidas");return;}
      addEntry(device,label,lat,lon);
    };

    // --- Función GPS automática ---
    function tryGeolocation() {
      const btn = document.getElementById('btn-get');
      if (!navigator.geolocation) { alert('Geolocation no disponible.'); return; }
      btn.disabled = true; btn.textContent = 'Solicitando…';

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          document.getElementById('lat').value = lat;
          document.getElementById('lon').value = lon;
          map.setView([lat, lon], 15, { animate: true });

          btn.disabled = false; btn.textContent = 'Obtener ubicación (GPS)';
        },
        err => {
          console.error(err);
          alert('No se pudo obtener la ubicación. Verifica permisos y conexión.');
          btn.disabled = false; btn.textContent = 'Obtener ubicación (GPS)';
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }
    document.getElementById('btn-get').onclick = tryGeolocation;

    document.getElementById("btn-clear").onclick=()=>{ if(confirm("¿Borrar todo el historial?")){ entries=[]; save(); refresh(); } };
    document.getElementById("filter").onchange=()=>render();

    document.getElementById("btn-export").onclick=()=>{
      if(entries.length===0){alert("No hay registros para exportar.");return;}
      let csv="Dispositivo,Etiqueta,Latitud,Longitud,Fecha\n";
      entries.forEach(e=>{ csv+=`"${e.device}","${e.label}",${e.lat},${e.lon},"${e.ts}"\n`; });
      const blob=new Blob([csv],{type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="gps_historial.csv"; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById("btn-import").onclick=()=>{ document.getElementById("file-import").click(); };
    document.getElementById("file-import").onchange=(e)=>{
      const file=e.target.files[0]; if(!file)return;
      const reader=new FileReader();
      reader.onload=(ev)=>{
        const lines=ev.target.result.split(/\r?\n/).slice(1);
        lines.forEach(line=>{
          if(!line.trim())return;
          const parts=line.split(",");
          if(parts.length>=5){
            const device=parts[0].replace(/"/g,"");
            const label=parts[1].replace(/"/g,"");
            const lat=parseFloat(parts[2]); const lon=parseFloat(parts[3]); const ts=parts[4].replace(/"/g,"");
            if(!isNaN(lat)&&!isNaN(lon)) entries.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),device,label,lat,lon,ts});
          }
        });
        save(); refresh();
      };
      reader.readAsText(file);
    };

    document.getElementById("btn-sample").onclick=()=>{
      const samples=[
        {device:"Teléfono Mamá",label:"Casa",lat:8.983,lon:-79.516},
        {device:"Teléfono Mamá",label:"Trabajo",lat:8.994,lon:-79.520},
        {device:"Reloj Niño",label:"Escuela",lat:9.010,lon:-79.505},
        {device:"Reloj Niño",label:"Parque",lat:9.015,lon:-79.500},
        {device:"Tracker Bici",label:"Ruta A",lat:9.050,lon:-79.480},
        {device:"Tracker Bici",label:"Ruta B",lat:9.060,lon:-79.470}
      ];
      samples.forEach(s=>addEntry(s.device,s.label,s.lat,s.lon));
    };

    document.addEventListener("DOMContentLoaded",()=>{ initMap(); load(); refresh(); });
  </script>
</body>
</html>











